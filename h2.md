# h2 Break & Unbreak

## Ympäristö
### Host-kone:
Lenovo Yoga Slim 7 Pro 17ACH5 OD

Processor	AMD Ryzen 9 5900HS Creator Edition (3.30 GHz)

Installed RAM	16.0 GB (15.4 GB usable)

System type	64-bit operating system, x64-based processor

OS: Windows 11

### Virtuaalikone
Oracle VirtualBox:

OS: Debian (64-bit)

Selain: Mozilla Firefox

ISO image: debian-live-12.9.0-amd64-xfce.

<img width="500" height="492" alt="image" src="https://github.com/user-attachments/assets/c7e855c3-aa6c-42d8-91df-2d5e15a97387" />


## x) Read/watch/listen and summarize
### OWASP: OWASP Top 10: A01 Broken Access Control
https://owasp.org/Top10/2021/A01_2021-Broken_Access_Control/index.html

- Broken access control eli rikkinäinen pääsynhallinta on yksi yleisimmistä haavoittuvuuksista.
Tämä mahdollistaa luvattoman pääsyn tietoihin, niiden muokkaamisen tai tuhoamisen.
- Yleisiä haavoittuvuuksia on esim:
  - Liian isot käyttöoikeudet (principle of least privilege tai deny by default käyttämättä jättäminen)
  - Pääsynhallinnan ohitus muokkaamalla URLia
  - Korotetut oikeudet
- Haavoittuvuuksia voi estää:
  - Deny by default: Estetään kaikki oletuksena
  - Pääsynhallinnan mekanismien uudelleenkäyttö aplikaation eri osissa
  - Uloskirjautumisen jälkeen istuntotunnisteet tulisi mitätöidä
  - Tulee varmistaa, että käyttäjällä on CRUD-oikeudet vain omiin tietoihin --> Voi muokata vain omia tietoja

 ### Karvinen 2023: Find Hidden Web Directories - Fuzz URLs with ffuf
 https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/

- Web palvelimilla on usein piilotettuja hakemistoja, joita ei voi löytää klikkailemalla web-sivun linkkejä.
- Ffuf on työkalu, jonka avulla pystyy löytämään näitä piilotettuja hakemistoja ilman manuaalista testailua.
- Piilotettujen hakemistojen löytämisesti täytyy asentaa ffuf ja ladata haluttu sanakirja. Ffuf testaa jokaista sanakirjan sanaa
URLiin määrittelemääsi kohtaan.

### PortSwigger: Access control vulnerabilities and privilege escalation
https://portswigger.net/web-security/access-control

- Pääsynhallinta = Määrittää, onko käyttäjällä valtuuksia päästä resursseihin tai oikeus muokata niitä.
Vaatii autentikaatiota eli varmistetaan käyttäjän olevan kuka väittää olevansa. Autentikaation jälkeen
istunnon hallinta tunnistaa saman käyttäjän HTTP-pyynnöt.
- Vertikaalinen pääsynhallinta = Käyttäjät, joilla on eri rooli tai erilaiset käyttöoikeudet, eivät pysty
pysty suorittamaan toistensa toimintoja.
- Vertical privilege escalation = Käyttäjä saa oikeuksia toimintoihin, joita ei kuuluisi olla. Esim:
  - Suojaamaton toiminto
  - Parametriin pohjautuva pääsynhallinta: Kirjautumisen yhteydessä määritellään käyttäjän oikeudet ja niitä säilytetään
  paikassa, jota käyttäjä voi muokata 
- Horisontaalinen pääsynhallinta = Käyttäjät, joilla on sama rooli tai samat käyttöoikeudet, voivat ainoastaan päästä omiin tietoihinsa käsiksi, ei toisten käyttäjien.
- Horizontal privilege escalation = Käyttäjä pääsee käsiksi jonkun toisen käyttäjän tietoihin.
  - Esim. Muuttamalla URLista jostain parametria, voi päästä toisen käyttäjän tietoihin käsiksi.
- Horizontal to vertical privilege escalation: Käyttäjä pääsee ensin käsiksi jonkun toisen käyttäjän tietoihin, jolla on korkeammat oikeudet ja sitten käyttää näitä korkeampia oikeuksia.
- Konteksti riippuvainen pääsynhallinta = Estää käyttäjää suorittamasta toimintoja väärässä järjestyksessä.
- Pääsynhallinnan haavoittuvuuksia hallitaan defense-in-depth lähestymistavalla.

### Karvinen 2006: Report Writing
https://terokarvinen.com/2006/raportin-kirjoittaminen-4/

- Raportissa kerrotaan täsmällisesti tapahtumien kulku ja sitä kirjoitetaan samaan aikaan tekemisen ohella.
- Raportin vaatimukset:
  - Toistettava: Raportoitu työ tulee olla toistettavissa samalla lopputuloksella seuraamalla raportin vaiheita.
  - Täsmällinen: Raportin tulee olla yksityiskohtainen (komennot, kellonajat, onnistumiset, epäonnistumiset, työkalut, ympäristö)
  - Helppolukuinen: Käytettävä otsikoita ja väliotsikoita sekä kirjoittaa huolellisesti.
  - Lähdeviitteet: Lähdeluettelo ja viitteet
- Tulee raportoida vain oikean tekemisen pohjalta, raporttia ei saa keksiä tyhjästä.
- Plagiointi ja kuvien luvaton kopiointi on kielletty.

## a) Break into 010-staff-only
Karvinen 2024: Hack'n Fix https://terokarvinen.com/hack-n-fix/

Haetaan ensin listaus päivityksistä:

    sudo apt-get update

Asennetaan sen jälkee wget, unzip ja micro

    sudo apt-get -y install wget unzip micro

Ladataan seuraavaksi tehtäviä varten Tero Karvisen zip-tiedosto ja avataan se:

    wget https://terokarvinen.com/hack-n-fix/teros-challenges.zip
    unzip teros-challenges.zip

Nyt voi aloittaa 010-staff-only tehtävän ratkaisun

Siirrytään oikeaan hakemistoon ja koitetaan avata tehtävä.

    cd challenges/010-staff-only/
    python3 staff-only.py

Vastaukseksi tuli: ModuleNotFoundError: No module named 'flask'

Asennetaan tarvittava ohjelma

    sudo apt-get -y install python3-flask python3-flask-sqlalchemy

Koitetaan käynnistää tehtävä uudestaan samalla komennolla. Tulee varoitus ja kerrotaan mistä osoitteesta tehtävän löytää.

<img width="1407" height="324" alt="image" src="https://github.com/user-attachments/assets/3881f7f8-6026-428c-9b76-127d9240b4be" />

Avataan Mozilla Firefox ja kirjoitetaan osoite http://127.0.0.1:5000

<img width="725" height="600" alt="image" src="https://github.com/user-attachments/assets/f43f1b5c-7c09-4c84-8a56-4e0602fbe291" />

Kokeilin laittaa PIN-koodin syöttökenttään ' OR 1=1; -- mutta tämä ei tuottanut tulosta. Tuli vain ilmoitus "Please enter a number". 

<img width="668" height="350" alt="image" src="https://github.com/user-attachments/assets/9bad3de8-6a38-4afd-a6d8-a067fc90ee93" />

Sivun alalaidassa on neuvo, jossa kerrotaan, millä SQL-lauseella tietokannasta haetaan PIN-koodia vastaava salasana:

    SELECT password FROM pins WHERE pin='123';

Tämä tarkoittaa: Valitse salasana pins-taulusta, jossa PIN-koodin arvo on käyttäjän syöttämä arvo.

Tällöin kenttään syöttäessä ' OR 1=1; -- SQL-lause olisi:

    SELECT password FROM pins WHERE pin='' OR 1=1; --';

Kun pins-taulu skannataan läpi, jokaisen PIN-koodin kohdalla tarkastetaan onko se '' eli tyhjä vai täyttääkö se ehdon 1=1 eli onko se totta. Koska kaikki PIN-koodit täyttävät ehdon 1=1, jokaista PIN-koodia vastaava salasana palautetaan. Lopussa olevat kaksi viivaa merkitsevät kommentin alun, jolloin viivojen jälkeen olevia merkkejä ei tulkita SQL-kielellä.

Koska tämä ei toiminut, luultavasti on koodattu niin, että syötteeseen hyväksytään vain numeroita.

Avataan selaimesta Developer Tools ja tarkistetaan HTML-koodi. Valitsin hiirellä hakukentän elementin, jolloin löysin sen Inspector -välilehdessä HTML-koodista. Huomasin, että hakukentän input-tyypiksi on laitettu 'number', jolloin hakukenttään voi syöttää ainoastaan numeroita. Vaihdoin input-tyypiksi 'text' (GeeksforGeeks 2025: HTML Input Type).

<img width="946" height="285" alt="image" src="https://github.com/user-attachments/assets/ec0abf16-f52b-4ea0-b9f5-bf75d5d5121a" />

Syötin kenttään uudestaan saman tekstin kuin aiemmin eli ' OR 1=1; -- Tällä kertaa ei tullutkaan ilmoitusta, jossa pyydetään syöttämään vain numeroita. Sain vastaukseksi salasanan 'foo'. Tämä ei kuitenkaan ole se admin salasana.

<img width="394" height="84" alt="image" src="https://github.com/user-attachments/assets/4b30e834-132b-4585-8dc3-aaca4d2ca875" />

Etsin netistä erilaisia SQL-injektioita ja löysin UNION SQL-injektion (Pentest Tools: Breaking down the 5 most common SQL injection attacks). UNION -operaattorin avulla voidaan yhdistää kaksi SELECT -lausetta. Ensin siinä suoritetaan oikean käyttötarkoituksen SQL-lause ja siihen yhdistetään SQL-injektiona lause, jonka avulla hakkeri saa suoritettua tietokantaan haluamansa kyselyn.

Lauseessa SELECT password FROM pins WHERE pin='syöte' kohta WHERE pin='syöte' on ongelmallinen, koska se vaatii PIN-koodin, jota vastaavan salasanan se palauttaa. Koska en tiedä mikä on admin-käyttäjän PIN-koodi, en pysty löytämään myöskään sen salasanaa. Tehdään tästä ensimmäisestä lauseesta uusi versio, josta puuttuu WHERE. Jotta ensimmäisestä lauseesta ei tule hakutuloksia, laitetaan se etsimään tyhjää PIN-koodia. Syötekenttään laitettava teksi näyttää siis tältä:

    ' UNION SELECT password FROM pins; --

Koko SQL-lause on siten:

    SELECT password FROM pins WHERE pin='' UNION SELECT password FROM pins; --

Tiedetään, että ensimmäiselle lauseelle ei tule yhtään hakutuloksia, jolloin vastaukseksi saadaan vain UNION -operaattorin jälkeen olevan lauseen tulokset. Jälkimmäinen lause hakee siis kaikki salasanat pins -taulusta.

Lopputuloksena löydettiin admin salasana:

<img width="1632" height="116" alt="image" src="https://github.com/user-attachments/assets/ce8c86a1-807d-4038-87ae-09e32399243c" />



## Lähteet
- Karvinen 2026: Application hacking - 2026 Spring: https://terokarvinen.com/application-hacking/
- OWASP: OWASP Top 10: A01 Broken Access Control: https://owasp.org/Top10/2021/A01_2021-Broken_Access_Control/index.html
- Karvinen 2023: Find Hidden Web Directories - Fuzz URLs with ffuf: https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/
- PortSwigger: Access control vulnerabilities and privilege escalation: https://portswigger.net/web-security/access-control
- Karvinen 2006: Report Writing: https://terokarvinen.com/2006/raportin-kirjoittaminen-4/
- Karvinen 2024: Hack'n Fix https://terokarvinen.com/hack-n-fix/
- GeeksforGeeks 2025: HTML Input Type: https://www.geeksforgeeks.org/html/html-input-type/
- Pentest Tools: Satyam Singh, Kelyan Yesil 2024: Breaking down the 5 most common SQL injection attacks: https://pentest-tools.com/blog/sql-injection-attacks#3-union-based-sql-injection
