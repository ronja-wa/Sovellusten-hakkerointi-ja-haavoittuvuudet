# h2 Break & Unbreak

## Ympäristö
### Host-kone:
Lenovo Yoga Slim 7 Pro 17ACH5 OD

Processor	AMD Ryzen 9 5900HS Creator Edition (3.30 GHz)

Installed RAM	16.0 GB (15.4 GB usable)

System type	64-bit operating system, x64-based processor

OS: Windows 11

### Virtuaalikone
Oracle VirtualBox:

OS: Debian (64-bit)

Verkko: NAT

Selain: Mozilla Firefox

ISO image: debian-live-12.9.0-amd64-xfce.

<img width="500" height="492" alt="image" src="https://github.com/user-attachments/assets/c7e855c3-aa6c-42d8-91df-2d5e15a97387" />


## x) Read/watch/listen and summarize
### OWASP: OWASP Top 10: A01 Broken Access Control
https://owasp.org/Top10/2021/A01_2021-Broken_Access_Control/index.html

- Broken access control eli rikkinäinen pääsynhallinta on yksi yleisimmistä haavoittuvuuksista.
Tämä mahdollistaa luvattoman pääsyn tietoihin, niiden muokkaamisen tai tuhoamisen.
- Yleisiä haavoittuvuuksia on esim:
  - Liian isot käyttöoikeudet (principle of least privilege tai deny by default käyttämättä jättäminen)
  - Pääsynhallinnan ohitus muokkaamalla URLia
  - Korotetut oikeudet
- Haavoittuvuuksia voi estää:
  - Deny by default: Estetään kaikki oletuksena
  - Pääsynhallinnan mekanismien uudelleenkäyttö aplikaation eri osissa
  - Uloskirjautumisen jälkeen istuntotunnisteet tulisi mitätöidä
  - Tulee varmistaa, että käyttäjällä on CRUD-oikeudet vain omiin tietoihin --> Voi muokata vain omia tietoja

 ### Karvinen 2023: Find Hidden Web Directories - Fuzz URLs with ffuf
 https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/

- Web palvelimilla on usein piilotettuja hakemistoja, joita ei voi löytää klikkailemalla web-sivun linkkejä.
- Ffuf on työkalu, jonka avulla pystyy löytämään näitä piilotettuja hakemistoja ilman manuaalista testailua.
- Piilotettujen hakemistojen löytämisesti täytyy asentaa ffuf ja ladata haluttu sanakirja. Ffuf testaa jokaista sanakirjan sanaa
URLiin määrittelemääsi kohtaan.

### PortSwigger: Access control vulnerabilities and privilege escalation
https://portswigger.net/web-security/access-control

- Pääsynhallinta = Määrittää, onko käyttäjällä valtuuksia päästä resursseihin tai oikeus muokata niitä.
Vaatii autentikaatiota eli varmistetaan käyttäjän olevan kuka väittää olevansa. Autentikaation jälkeen
istunnon hallinta tunnistaa saman käyttäjän HTTP-pyynnöt.
- Vertikaalinen pääsynhallinta = Käyttäjät, joilla on eri rooli tai erilaiset käyttöoikeudet, eivät pysty
pysty suorittamaan toistensa toimintoja.
- Vertical privilege escalation = Käyttäjä saa oikeuksia toimintoihin, joita ei kuuluisi olla. Esim:
  - Suojaamaton toiminto
  - Parametriin pohjautuva pääsynhallinta: Kirjautumisen yhteydessä määritellään käyttäjän oikeudet ja niitä säilytetään
  paikassa, jota käyttäjä voi muokata 
- Horisontaalinen pääsynhallinta = Käyttäjät, joilla on sama rooli tai samat käyttöoikeudet, voivat ainoastaan päästä omiin tietoihinsa käsiksi, ei toisten käyttäjien.
- Horizontal privilege escalation = Käyttäjä pääsee käsiksi jonkun toisen käyttäjän tietoihin.
  - Esim. Muuttamalla URLista jostain parametria, voi päästä toisen käyttäjän tietoihin käsiksi.
- Horizontal to vertical privilege escalation: Käyttäjä pääsee ensin käsiksi jonkun toisen käyttäjän tietoihin, jolla on korkeammat oikeudet ja sitten käyttää näitä korkeampia oikeuksia.
- Konteksti riippuvainen pääsynhallinta = Estää käyttäjää suorittamasta toimintoja väärässä järjestyksessä.
- Pääsynhallinnan haavoittuvuuksia hallitaan defense-in-depth lähestymistavalla.

### Karvinen 2006: Report Writing
https://terokarvinen.com/2006/raportin-kirjoittaminen-4/

- Raportissa kerrotaan täsmällisesti tapahtumien kulku ja sitä kirjoitetaan samaan aikaan tekemisen ohella.
- Raportin vaatimukset:
  - Toistettava: Raportoitu työ tulee olla toistettavissa samalla lopputuloksella seuraamalla raportin vaiheita.
  - Täsmällinen: Raportin tulee olla yksityiskohtainen (komennot, kellonajat, onnistumiset, epäonnistumiset, työkalut, ympäristö)
  - Helppolukuinen: Käytettävä otsikoita ja väliotsikoita sekä kirjoittaa huolellisesti.
  - Lähdeviitteet: Lähdeluettelo ja viitteet
- Tulee raportoida vain oikean tekemisen pohjalta, raporttia ei saa keksiä tyhjästä.
- Plagiointi ja kuvien luvaton kopiointi on kielletty.

## a) Break into 010-staff-only
Karvinen 2024: Hack'n Fix https://terokarvinen.com/hack-n-fix/

Haetaan ensin listaus päivityksistä:

    sudo apt-get update

Asennetaan sen jälkee wget, unzip ja micro

    sudo apt-get -y install wget unzip micro

Ladataan seuraavaksi tehtäviä varten Tero Karvisen zip-tiedosto ja avataan se:

    wget https://terokarvinen.com/hack-n-fix/teros-challenges.zip
    unzip teros-challenges.zip

Nyt voi aloittaa 010-staff-only tehtävän ratkaisun

Siirrytään oikeaan hakemistoon ja koitetaan avata tehtävä.

    cd challenges/010-staff-only/
    python3 staff-only.py

Vastaukseksi tuli: ModuleNotFoundError: No module named 'flask'

Asennetaan tarvittava ohjelma

    sudo apt-get -y install python3-flask python3-flask-sqlalchemy

Koitetaan käynnistää tehtävä uudestaan samalla komennolla. Tulee varoitus ja kerrotaan mistä osoitteesta tehtävän löytää.

<img width="1407" height="324" alt="image" src="https://github.com/user-attachments/assets/3881f7f8-6026-428c-9b76-127d9240b4be" />

Avataan Mozilla Firefox ja kirjoitetaan osoite http://127.0.0.1:5000

<img width="725" height="600" alt="image" src="https://github.com/user-attachments/assets/f43f1b5c-7c09-4c84-8a56-4e0602fbe291" />

Kokeilin laittaa PIN-koodin syöttökenttään ' OR 1=1; -- mutta tämä ei tuottanut tulosta. Tuli vain ilmoitus "Please enter a number". 

<img width="668" height="350" alt="image" src="https://github.com/user-attachments/assets/9bad3de8-6a38-4afd-a6d8-a067fc90ee93" />

Sivun alalaidassa on neuvo, jossa kerrotaan, millä SQL-lauseella tietokannasta haetaan PIN-koodia vastaava salasana:

    SELECT password FROM pins WHERE pin='123';

Tämä tarkoittaa: Valitse salasana pins-taulusta, jossa PIN-koodin arvo on käyttäjän syöttämä arvo.

Tällöin kenttään syöttäessä ' OR 1=1; -- SQL-lause olisi:

    SELECT password FROM pins WHERE pin='' OR 1=1; --';

Kun pins-taulu skannataan läpi, jokaisen PIN-koodin kohdalla tarkastetaan onko se '' eli tyhjä vai täyttääkö se ehdon 1=1 eli onko se totta. Koska kaikki PIN-koodit täyttävät ehdon 1=1, jokaista PIN-koodia vastaava salasana palautetaan. Lopussa olevat kaksi viivaa merkitsevät kommentin alun, jolloin viivojen jälkeen olevia merkkejä ei tulkita SQL-kielellä.

Koska tämä ei toiminut, luultavasti on koodattu niin, että syötteeseen hyväksytään vain numeroita.

Avataan selaimesta Developer Tools ja tarkistetaan HTML-koodi. Valitsin hiirellä hakukentän elementin, jolloin löysin sen Inspector -välilehdessä HTML-koodista. Huomasin, että hakukentän input-tyypiksi on laitettu 'number', jolloin hakukenttään voi syöttää ainoastaan numeroita. Vaihdoin input-tyypiksi 'text' (GeeksforGeeks 2025: HTML Input Type).

<img width="946" height="285" alt="image" src="https://github.com/user-attachments/assets/ec0abf16-f52b-4ea0-b9f5-bf75d5d5121a" />

Syötin kenttään uudestaan saman tekstin kuin aiemmin eli ' OR 1=1; -- Tällä kertaa ei tullutkaan ilmoitusta, jossa pyydetään syöttämään vain numeroita. Sain vastaukseksi salasanan 'foo'. Tämä ei kuitenkaan ole se admin salasana.

<img width="394" height="84" alt="image" src="https://github.com/user-attachments/assets/4b30e834-132b-4585-8dc3-aaca4d2ca875" />

Etsin netistä erilaisia SQL-injektioita ja löysin UNION SQL-injektion (Pentest Tools: Breaking down the 5 most common SQL injection attacks). UNION -operaattorin avulla voidaan yhdistää kaksi SELECT -lausetta. Ensin siinä suoritetaan oikean käyttötarkoituksen SQL-lause ja siihen yhdistetään SQL-injektiona lause, jonka avulla hakkeri saa suoritettua tietokantaan haluamansa kyselyn.

Lauseessa SELECT password FROM pins WHERE pin='syöte' kohta WHERE pin='syöte' on ongelmallinen, koska se vaatii PIN-koodin, jota vastaavan salasanan se palauttaa. Koska en tiedä mikä on admin-käyttäjän PIN-koodi, en pysty löytämään myöskään sen salasanaa. Tehdään tästä ensimmäisestä lauseesta uusi versio, josta puuttuu WHERE. Jotta ensimmäisestä lauseesta ei tule hakutuloksia, laitetaan se etsimään tyhjää PIN-koodia. Syötekenttään laitettava teksi näyttää siis tältä:

    ' UNION SELECT password FROM pins; --

Koko SQL-lause on siten:

    SELECT password FROM pins WHERE pin='' UNION SELECT password FROM pins; --

Tiedetään, että ensimmäiselle lauseelle ei tule yhtään hakutuloksia, jolloin vastaukseksi saadaan vain UNION -operaattorin jälkeen olevan lauseen tulokset. Jälkimmäinen lause hakee siis kaikki salasanat pins -taulusta.

Lopputuloksena löydettiin admin salasana:

<img width="1632" height="116" alt="image" src="https://github.com/user-attachments/assets/ce8c86a1-807d-4038-87ae-09e32399243c" />

## b) Fix the 010-staff-only vulnerability from source code. Demonstrate with a test that your solution works.

Avataan lähdekoodi microlla ja tarkastellaan sitä.

    micro challenges/010-staff-only/staff-only.py

Koodi on kirjoitettu pythonilla. Sen huomaa myös nimestä, koska se on .py -loppuinen. Koodissa käytetään SQLAlchemyn kirjastoa, minkä näkee heti koodin alussa. Ongelmana oli se, että teksin syöttö oli rajoitettu HTML-koodissa eikä lähdekoodissa.

Koodivirhe, joka sallii SQL-injektion, löytyy riviltä 22. PIN-koodi lisätään suoraan SQL-lauseeseen syötekentästä, jolloin ei voida kontrolloida sitä, mitä käyttäjä siihen saa syöttää.

<img width="776" height="500" alt="image" src="https://github.com/user-attachments/assets/47ba8255-bbc6-41ad-aec5-5c6049aaea77" />

Muokataan koodia siten, ettei käyttäjän syötettä lisätä suoraan SQL-lauseeseen, vaan parametrina (Medium: Oli Chase 2023: How To Protect Your Code From SQL Injection Attacks). 

<img width="562" height="300" alt="image" src="https://github.com/user-attachments/assets/4d0aad6c-f40d-45b2-aea7-1728106860d8" />

Testataan vielä, ettei a-kohdan SQL-injektiota pysty enää suorittamaan. Muokataan taas HTML-koodin input type tekstiksi ja sen jälkeen syötetään syötekenttään ' UNION SELECT password FROM pins; --

<img width="524" height="500" alt="image" src="https://github.com/user-attachments/assets/2f9457ef-da04-4db6-9921-0ac6858b3d19" />

Salasanaa ei tällä kertaa saatukaan, joten voidaan todeta lähdekoodin korjauksen onnistuneen.

## c)  Solve dirfuzt-1 from the article Karvinen 2023: Find Hidden Web Directories - Fuzz URLs with ffuf

Tehtävän tarkoituksena on löytää piiloitettu admin -sivu 

Ladataan suoritettava tehtävä.

    wget https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/dirfuzt-1

Muokataan käyttöoikeuksia siten, että ladatun tiedoston pystyy suorittamaan (execute = x)

    chmod u+x dirfuzt-1

Siirrytään Downloads -hakemistoon.

    cd Downloads/

Käynnistetään ohjelma

    ./dirfuzt-1

Siirrytään selaimella sivulle, jolle ohjelma ohjaa.

    Learn more at TeroKarvinen.com
    http://127.0.0.2:8000


<img width="1010" height="275" alt="image" src="https://github.com/user-attachments/assets/bd6495c1-2d30-4c52-8450-891eb190a6f7" />

Avataan terminaali uudessa ikkunassa ja asennetaan ffuf.

    sudo apt-get update
    sudo apt-get install ffuf

Ladataan myös sanakirja ffufin käyttöä varten (Daniel Miessler: SecList)

    wget https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/common.txt

Irroitetaan virtuaalikone verkosta ennen kuin aletaan käyttämään ffuf-työkalua.

<img width="736" height="264" alt="image" src="https://github.com/user-attachments/assets/be9ef9c2-9cbb-4b07-b10a-20e5a6c4eb08" />

Siirytään hakemistoon, jossa ffuf on ja tarkastellaan sen eri parametreja.

    cd /bin
    ./ffuf |& less

-u avulla lisätään kohde-URL
-w avulla lisätään sanakirja, jonka sanoja kokeillaan URLiin.


<img width="497" height="53" alt="image" src="https://github.com/user-attachments/assets/df377fba-57da-4671-9a25-5b2599d41d89" />

<img width="1402" height="89" alt="image" src="https://github.com/user-attachments/assets/95d87cd1-07be-4fda-92b1-82204b4cc9a0" />

Parametrilistassa on myös esimerkkikomento. Sana 'FUZZ' laitetaan sille paikalle URLissa, johon sanakirjan sanoja halutaaan kokeilla.

<img width="860" height="44" alt="image" src="https://github.com/user-attachments/assets/34e843e0-9051-457c-b8aa-3c9e61af34ba" />

Suoritetaan komento.

    ./ffuf -w /home/sieni/common.txt -u http://127.0.0.2:8000/FUZZ

Vastauksia tuli todella paljon ja olisi raskasta käydä ne läpi manuaalisesti. Vastauksista huomataan, että niillä on kaikilla sama status, koko ja sanamäärä, joten käytetään tätä tietoa hyväksi.

<img width="1532" height="251" alt="image" src="https://github.com/user-attachments/assets/40bf5139-8523-4ffd-94fa-90498abf5407" />

Suodatetaan käyttämällä vastauksen kokoa, joka näyttäisi olevan kaikissa ei-toivotuissa vastauksissa 154 tavua.

    ./ffuf -w /home/sieni/common.txt -u http://127.0.0.2:8000/FUZZ -fs 154

Vastauksia tuli nyt paljon vähemmän.

<img width="1562" height="712" alt="image" src="https://github.com/user-attachments/assets/a9985c46-d94c-41a3-b20a-afc3256e6241" />

Testataan jotain sellaista sanaa, jonka status on 200 eli OK. Tästä listasta todennäköisimmältä omaan silmään näyttäisi wp-admin, joten kokeillaan sitä.

<img width="838" height="374" alt="image" src="https://github.com/user-attachments/assets/2d4bb369-3395-468a-9caf-a3c3e64068d6" />

Se osoittautui oikeaksi! Myös kaikista .git -alkuisista löytyi toinen sivu:

<img width="833" height="363" alt="image" src="https://github.com/user-attachments/assets/a2048c9f-7d82-4375-9e5a-a1c65dce45a9" />

## Break into 020-your-eyes-only. See Karvinen 2024: Hack'n Fix

Tehtävässä on tarkoitus päästä käsiksi hallintakonsoliin.

Siirrytään tehtävän hakemistoon.

    cd challenges/020-your-eyes-only/

Luodaan virtuaaliympäristö ja aktivoidaan se.

    sudo apt-get -y install virtualenv

    virtualenv virtualenv/ -p python3 --system-site-packages

    source virtualenv/bin/activate

Tarkistetaan requirements.txt -tiedostosta mikä Django pitää asentaa.

    cat requirements.txt
    django==4.2.*

Asennetaan kyseinen Django requirements.txt -tiedoston avulla, jotta ei varmasti tule kirjoitusvirheitä. Asennettiin versio django-4.2.27.  
    
    pip install -r requirements.txt
    Successfully installed django-4.2.27

Siirrytään kotihakemistossa kansioon challenges/020-your-eyes-only/logtin/

    cd /home/sieni/challenges/020-your-eyes-only/logtin/

Päivitetään tietokanta.

    ./manage.py makemigrations; ./manage.py migrate

Tässä välissä irroitin virtuaalikoneen netistä varmuuden vuoksi.

Käynnistetään palvelin.

    ./manage.py runserver
    Django version 4.2.27, using settings 'logtin.settings'
    Starting development server at http://127.0.0.1:8000/

<img width="2017" height="963" alt="image" src="https://github.com/user-attachments/assets/d59466d1-3612-4800-9f9d-fb7b915096c9" />

Koitetaan löytää piilotettuja hakemistoja eli sellaisia, joihin ei pääse suoraan klikkailemalla verkkosivulla. Käytetään työkaluna ffufia.

Siirrytään bin -hakemistoon.

    cd /bin

Käytetään samaa sanakirjaa kuin c-kohdassa.

    ./ffuf -w /home/sieni/common.txt -u http://127.0.0.1:8000/FUZZ

Vastaukset tuli sen verran hitaasti, että kerkesin reaaliajassa seuraamaan niitä. Huomasin poikkeavan vastauksen:

<img width="1177" height="65" alt="image" src="https://github.com/user-attachments/assets/96c59ecb-3ac2-4d83-824d-3b4e996e378d" />

Testataan URLin perään /admin-console

Se kuitenkin vain ohjasi kirjautumissivulle

<img width="770" height="65" alt="image" src="https://github.com/user-attachments/assets/a4a7717e-0291-4dd9-853c-9b504ecc6b2d" />

Testataan tätä URLia ffufin avulla.

    ./ffuf -w /home/sieni/common.txt -u http://127.0.0.1:8000/accounts/login/?next=/admin-dashboard/

Ei-toivottujen vastausten koko näyttäisi olevan 1583 tavua, joten käytetään sitä suodattamisessa.

<img width="1400" height="371" alt="image" src="https://github.com/user-attachments/assets/781f643b-0418-4753-b326-dc9083cdb295" />

    ./ffuf -w /home/sieni/common.txt -u http://127.0.0.1:8000/accounts/login/?next=/admin-dashboard/ -fs 1583    

Ei tullut vastausta. Testasin muillekin sivuille mutta mistään ei tullut vastausta.

Seuraavaksi kävin luomassa itselleni tunnuksen Register -sivulla, jotta voisin kirjautua sisään ja nähdä miltä URL näyttää, kun on kirjautuneena sisälle.

Sisäänkirjautuneena uusi vaihtoehto URLin perään oli /my-data, mutta sen perään ei löytynyt ffufin avulla mitään vaihtoehtoja.

Sitten muistin, että heti ensimmäisellä ffuf -testillä etusivun URLin perään löytyi yksi sana: /admin-console. Kokeillaan vielä sitä kerran sisäänkirjautuneena.

<img width="1680" height="570" alt="image" src="https://github.com/user-attachments/assets/a1dbc091-5cb1-434d-b216-980703f84145" />

Sehän onnistui! Hallintasivu löytyi.


## e) Fix the 020-your-eyes-only vulnerability. Demonstrate with a test that your solution works

d-kohdassa havaittu ongelma liittyi puutteelliseen autentikointiin, joten se pitää korjata lähdekoodista.

Käyttäjän varmentamiseen ja käyttöoikeuksiin liittyvä tiedosto views.py löytyi hakemistosta ~/challenges/020-your-eyes-only/logtin/hats

<img width="1475" height="814" alt="image" src="https://github.com/user-attachments/assets/2a218947-8ac6-4c9e-8355-163ba717e7e5" />

Ensimmäinen luokka (class) liittyy oman datan katseluun ja siinä tarkistetaan onko käyttäjä autentikoitu.

Toinen luokka liittyy admin dashboardin katseluun ja siihen vaaditaan käyttäjän autentikointi sekä käyttäjä kuuluu ylläpitäjiin (.is_staff)

Kolmas luokka liittyy myös admin näkymään, mutta siinä vaaditaan pelkästään, että käyttäjä on autentikoitu. Eli kuka tahansa autentikoitu käyttäjä voi päästä tässä luokassa määriteltyyn näkymään, vaikka tarkoituksena olisi sallia vain admin -käyttäjät.

Lisätään viimeiseen luokkaa sama return lause kuin toisessa luokassa eli

    return self.request.user.is_authenticated and self.request.user.is_staff

<img width="1519" height="248" alt="image" src="https://github.com/user-attachments/assets/b2a64e2f-afd5-474e-978f-b50efac4e2e6" />

Tallennetaan ja käynnistetään palvelin uudestaan. Kirjaudutaan aiemmin luodulle käyttäjälle takaisin sisään kirjoitetaan URL http://127.0.0.1:8000/admin-console

<img width="920" height="263" alt="image" src="https://github.com/user-attachments/assets/35b713c3-f3d4-4483-8f41-b4eaa7a9baeb" />

Nyt pääsy on estetty.

## Lähteet
- Karvinen 2026: Application hacking - 2026 Spring: https://terokarvinen.com/application-hacking/
- OWASP: OWASP Top 10: A01 Broken Access Control: https://owasp.org/Top10/2021/A01_2021-Broken_Access_Control/index.html
- Karvinen 2023: Find Hidden Web Directories - Fuzz URLs with ffuf: https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/
- PortSwigger: Access control vulnerabilities and privilege escalation: https://portswigger.net/web-security/access-control
- Karvinen 2006: Report Writing: https://terokarvinen.com/2006/raportin-kirjoittaminen-4/
- Karvinen 2024: Hack'n Fix https://terokarvinen.com/hack-n-fix/
- GeeksforGeeks 2025: HTML Input Type: https://www.geeksforgeeks.org/html/html-input-type/
- Pentest Tools: Satyam Singh, Kelyan Yesil 2024: Breaking down the 5 most common SQL injection attacks: https://pentest-tools.com/blog/sql-injection-attacks#3-union-based-sql-injection
- Medium: Oli Chase 2023: How To Protect Your Code From SQL Injection Attacks: https://medium.com/@olichase91/how-to-protect-your-code-from-sql-injection-attacks-4814c9264c8
- Daniel Miessler GitHub: SecList: https://github.com/danielmiessler/SecLists


Ronja Wahlsten
